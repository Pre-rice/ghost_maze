<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>鬼迷宫</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>

        <div class="main-container">
            <!-- Canvas wrapper for layer panel positioning inside canvas -->
            <div class="canvas-wrapper">
                <canvas id="game-canvas" width="600" height="600"></canvas>
                <!-- Fix 3: 图层切换按钮面板（显示在Canvas内，右侧居中） -->
                <div id="layer-panel" class="layer-panel" style="display: none;">
                    <div id="layer-buttons-container">
                        <!-- 动态生成图层按钮 -->
                    </div>
                    <div id="layer-edit-controls" style="display: none;">
                        <button id="layer-add-btn" class="layer-control-btn">+</button>
                        <button id="layer-remove-btn" class="layer-control-btn">−</button>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <!-- Game Mode UI -->
                <div id="game-controls">
                    <div class="control-group">
                        <h3>状态</h3>
                        <!-- 右上角操作区：包含帮助和主题切换 -->
                        <div class="header-controls">
                            <!-- Home 按钮 -->
                            <div id="home-btn" class="home-btn" title="回到首页">
                                <svg viewBox="0 0 24 24">
                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                </svg>
                            </div>

                            <!-- 帮助按钮 -->
                            <a href="help.html" class="help-btn" title="查看帮助" target="_blank">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                                </svg>
                            </a>
                            
                            <!-- 原有的主题切换按钮 (保持 ID 不变以兼容 JS) -->
                            <div class="theme-toggle" id="theme-toggle">
                                <div class="theme-toggle-btn" id="theme-toggle-btn">
                                    <svg id="theme-icon" viewBox="0 0 24 24"></svg>
                                </div>
                            </div>
                        </div>
                        <!-- 探索模式状态栏 -->
                        <div id="status-bar-exploration" class="status-bar">
                            <div id="player-health-display" class="label">生命:
                                5</div>
                            <div id="player-keys-display" class="label">钥匙:
                                0</div>
                            <div id="player-steps-display" class="label">步数:
                                0</div>
                            <div id="ghost-proximity-display"
                                class="label">周围鬼数: 0</div>
                        </div>
                        <!-- 死亡循环模式状态栏 -->
                        <div id="status-bar-death-loop" class="status-bar"
                            style="display: none;">
                            <div id="loop-count-display" class="label">循环次数:
                                0</div>
                            <div id="player-keys-display-death-loop"
                                class="label">钥匙: 0</div>
                            <div id="player-stamina-display" class="label">剩余体力:
                                100</div>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>控制</h3>
                        <div class="share-buttons-container">
                            <button id="undo-btn" class="secondary">撤回</button>
                            <button id="save-btn" class="secondary">存档</button>
                            <button id="rewind-btn"
                                class="secondary">回溯</button>
                        </div>
                        <div class="toggle-controls-wrapper">
                            <div class="toggle-switch">
                                <span class="label">调试视野</span>
                                <input type="checkbox" id="debug-vision-toggle">
                                <label for="debug-vision-toggle">Toggle</label>
                            </div>
                            <div id="dpad-toggle-container"
                                class="toggle-switch">
                                <span class="label">方向按键</span>
                                <input type="checkbox" id="dpad-toggle" checked>
                                <label for="dpad-toggle">Toggle</label>
                            </div>
                        </div>
                        <button id="generate-map-btn">随机生成新地图</button>
                        <button id="reset-map-btn">重置地图</button>
                    </div>

                    <div class="control-group">
                        <h3>地图选项</h3>
                        <label class="label">模式选择</label>
                        <div class="mode-selector">
                            <button id="mode-exploration-btn"
                                class="mode-btn active">探索模式</button>
                            <button id="mode-death-loop-btn"
                                class="mode-btn">死亡循环</button>
                        </div>
                        <div class="inline-control-group">
                            <label for="map-size-input">地图大小 (8-20):</label>
                            <input type="number" id="map-size-input" value="10"
                                min="8" max="20">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>分享</h3>
                        <div class="share-buttons-container">
                            <button id="copy-share-code-btn">复制分享码</button>
                            <button id="load-share-code-btn">粘贴并加载</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>编辑器</h3>
                        <button id="edit-map-btn">编辑地图</button>
                    </div>
                </div>

                <!-- Editor Mode UI -->
                <div id="editor-controls" style="display: none;">
                    <div class="control-group">
                        <h3>编辑器工具</h3>
                        <!-- 编辑器模式下的右上角操作按钮 -->
                        <div class="header-controls">
                            <!-- Home 按钮 -->
                            <div id="editor-home-btn" class="home-btn" title="回到首页">
                                <svg viewBox="0 0 24 24">
                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                </svg>
                            </div>
                            <!-- 帮助按钮 -->
                            <a href="help.html" class="help-btn" title="查看帮助" target="_blank">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                                </svg>
                            </a>
                            <!-- 主题切换按钮 -->
                            <div class="theme-toggle" id="editor-theme-toggle">
                                <div class="theme-toggle-btn" id="editor-theme-toggle-btn">
                                    <svg id="editor-theme-icon" viewBox="0 0 24 24"></svg>
                                </div>
                            </div>
                        </div>
                        <div class="editor-toolbar">
                            <button id="tool-wall" class="tool-btn icon-btn active" title="墙壁">
                                <svg viewBox="0 0 24 24" width="24" height="24"><line x1="2" y1="12" x2="22" y2="12" stroke="var(--wall-color)" stroke-width="3"/></svg>
                            </button>
                            <button id="tool-glass" class="tool-btn icon-btn" title="玻璃">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <line x1="5" y1="17" x2="9" y2="7" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="10" y1="17" x2="14" y2="7" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="15" y1="17" x2="19" y2="7" stroke="var(--wall-color)" stroke-width="2"/>
                                </svg>
                            </button>
                            <button id="tool-door" class="tool-btn icon-btn" title="门">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <line x1="2" y1="12" x2="8" y2="12" stroke="var(--wall-color)" stroke-width="3"/>
                                    <line x1="16" y1="12" x2="22" y2="12" stroke="var(--wall-color)" stroke-width="3"/>
                                </svg>
                            </button>
                            <button id="tool-oneway" class="tool-btn icon-btn" title="单向门">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <line x1="2" y1="16" x2="22" y2="16" stroke="var(--wall-color)" stroke-width="3"/>
                                    <polyline points="7,10 12,4 17,10" fill="none" stroke="var(--key-color)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
                                </svg>
                            </button>
                            <button id="tool-lock" class="tool-btn icon-btn" title="数字门">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <line x1="2" y1="12" x2="22" y2="12" stroke="var(--wall-color)" stroke-width="3"/>
                                    <text x="12" y="19" font-size="12" fill="var(--key-color)" text-anchor="middle" font-weight="bold" stroke="var(--wall-color)" stroke-width="0.5">1</text>
                                </svg>
                            </button>
                            <button id="tool-letter" class="tool-btn icon-btn" title="字母门">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <line x1="2" y1="12" x2="22" y2="12" stroke="var(--wall-color)" stroke-width="3"/>
                                    <text x="12" y="19" font-size="12" fill="var(--key-color)" text-anchor="middle" font-weight="bold" stroke="var(--wall-color)" stroke-width="0.5">A</text>
                                </svg>
                            </button>
                            <button id="tool-button" class="tool-btn icon-btn" title="按钮">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M6 4 L6 12 L18 12 L18 4" fill="none" stroke="var(--wall-color)" stroke-width="2"/>
                                    <text x="12" y="10" font-size="7" fill="var(--key-color)" text-anchor="middle" font-weight="bold">A</text>
                                </svg>
                            </button>
                            <button id="tool-ghost" class="tool-btn icon-btn" title="鬼">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <circle cx="12" cy="12" r="7" fill="var(--ghost-color)"/>
                                </svg>
                            </button>
                            <button id="tool-key" class="tool-btn icon-btn" title="钥匙">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <polygon points="12,4 19,12 12,20 5,12" fill="var(--key-color)"/>
                                </svg>
                            </button>
                            <!-- 新增起点工具 (自由模式显示) -->
                            <button id="tool-start" class="tool-btn icon-btn" style="display:none;" title="起点">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <circle cx="12" cy="12" r="7" fill="var(--player-color)"/>
                                </svg>
                            </button>
                            <button id="tool-end" class="tool-btn icon-btn" title="终点">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <circle cx="12" cy="12" r="7" fill="var(--end-point-color)"/>
                                </svg>
                            </button>
                            <!-- 橡皮擦工具 -->
                            <button id="tool-eraser" class="tool-btn icon-btn" title="橡皮擦">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <rect x="5" y="8" width="14" height="12" rx="2" fill="#aaaaaa"/>
                                    <rect x="7" y="5" width="10" height="5" fill="#dddddd"/>
                                </svg>
                            </button>
                            <!-- 新增楼梯工具 (仅多层地图模式显示) -->
                            <button id="tool-stair" class="tool-btn icon-btn" style="display:none;" title="楼梯">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M4 20 L4 14 L10 14 L10 8 L16 8 L16 2 L22 2 L22 20 Z" fill="none" stroke="var(--wall-color)" stroke-width="2"/>
                                </svg>
                            </button>
                            <!-- 新增地图方格工具 (自由模式显示) -->
                            <button id="tool-grid" class="tool-btn icon-btn" style="display:none;" title="地图方格">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <line x1="4" y1="4" x2="8" y2="4" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="12" y1="4" x2="20" y2="4" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="20" y1="4" x2="20" y2="8" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="20" y1="12" x2="20" y2="20" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="20" y1="20" x2="16" y2="20" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="12" y1="20" x2="4" y2="20" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="4" y1="20" x2="4" y2="16" stroke="var(--wall-color)" stroke-width="2"/>
                                    <line x1="4" y1="12" x2="4" y2="4" stroke="var(--wall-color)" stroke-width="2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="control-group">
                        <h3>控制</h3>
                        <!-- 新增：编辑器模式切换 -->
                        <label class="label">编辑类型</label>
                        <div class="mode-selector" style="margin-bottom: 10px;">
                            <button id="edit-type-regular-btn" class="mode-btn active">常规模式</button>
                            <button id="edit-type-free-btn" class="mode-btn">自由编辑</button>
                        </div>
                        <button id="play-edited-map-btn">游玩地图</button>
                        <button id="clear-map-btn" class="danger">清空地图</button>
                    </div>
                    <div class="control-group">
                        <h3>地图选项</h3>
                        <label class="label">游戏模式</label>
                        <div class="mode-selector">
                            <button id="editor-mode-exploration-btn"
                                class="mode-btn active">探索模式</button>
                            <button id="editor-mode-death-loop-btn"
                                class="mode-btn">死亡循环</button>
                        </div>
                        <!-- 新增：地图层数选择（仅自由编辑模式显示） -->
                        <div id="layer-mode-container" style="display: none;">
                            <label class="label">地图层数</label>
                            <div class="mode-selector">
                                <button id="layer-mode-single-btn"
                                    class="mode-btn active">单层地图</button>
                                <button id="layer-mode-multi-btn"
                                    class="mode-btn">多层地图</button>
                            </div>
                        </div>
                        <div class="inline-control-group">
                            <label for="editor-map-size-input">地图大小
                                (8-20):</label>
                            <input type="number" id="editor-map-size-input"
                                value="10" min="8" max="20">
                        </div>
                        <div id="initial-health-container"
                            class="inline-control-group">
                            <label for="editor-initial-health">初始生命:</label>
                            <input type="number" id="editor-initial-health"
                                value="5" min="1">
                        </div>
                        <div id="initial-stamina-container"
                            class="inline-control-group" style="display: none;">
                            <label for="editor-initial-stamina">初始体力:</label>
                            <input type="number" id="editor-initial-stamina"
                                value="100" min="1">
                        </div>
                    </div>
                    <div class="control-group">
                        <h3>分享</h3>
                        <div class="share-buttons-container">
                            <button
                                id="editor-copy-share-code-btn">复制分享码</button>
                            <button
                                id="editor-load-share-code-btn">粘贴并加载</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlays -->
        <div id="death-overlay" class="overlay">
            <div class="overlay-content">
                <h2 id="death-message">你死了</h2>
                <div class="buttons">
                    <button id="revive-btn">复活</button>
                </div>
            </div>
        </div>

        <div id="game-over-overlay" class="overlay">
            <div class="overlay-content">
                <h2>你死了，游戏结束</h2>
                <div class="buttons">
                    <button id="game-over-replay-btn">再次游玩该地图</button>
                    <button id="game-over-new-map-btn">游玩新地图</button>
                </div>
            </div>
        </div>

        <div id="win-overlay" class="overlay">
            <div class="overlay-content">
                <h2>你赢了！</h2>
                <p id="win-stats"></p>
                <div class="buttons">
                    <button id="win-replay-btn">再次游玩该地图</button>
                    <button id="win-new-map-btn">游玩新地图</button>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Overlay -->
        <div id="confirm-overlay" class="overlay">
            <div class="overlay-content">
                <p id="confirm-message">你确定吗？</p>
                <div class="buttons">
                    <button id="confirm-yes-btn" class="danger">确认</button>
                    <button id="confirm-no-btn" class="secondary">取消</button>
                </div>
            </div>
        </div>

        <!-- 清空地图的三选项确认浮窗 -->
        <div id="clear-map-confirm-overlay" class="overlay">
            <div class="overlay-content">
                <p>你希望？</p>
                <div class="buttons">
                    <button id="confirm-clear-entities-btn">清空元件</button>
                    <button id="confirm-reset-grids-btn" class="danger">重置方格</button>
                    <button id="confirm-clear-grids-btn" class="danger">清空方格</button>
                    <button id="confirm-clear-cancel-btn" class="secondary">取消</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast-notification" class="toast"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
        <script type="module" src="src/ghostMazeGame.js"></script>
        <div id="dpad-controls" style="display: none;">
            <div id="dpad-up" class="dpad-btn">▲</div>
            <div id="dpad-left" class="dpad-btn">◀</div>
            <div id="dpad-center" class="dpad-btn dpad-center">●</div> <!-- Fix 8: 中键与空格绑定，同时可拖动 -->
            <div id="dpad-right" class="dpad-btn">▶</div>
            <div id="dpad-down" class="dpad-btn">▼</div>
        </div>
    </body>
</html>

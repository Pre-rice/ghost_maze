# 🎮《鬼迷宫》——完整规则说明

## （一）游戏地图结构

### 1. 地图尺寸

* 大小8×8至20×20的网格地图
* 每个格子四周的边可以是“墙”或“空”，决定通行与否。

### 2. 墙的表示方式

* **墙位于格子边界**，而不是格子内部。
* 只有当两个相邻格子之间存在墙边时，玩家或鬼不能从该方向通行。

### 3. 连通性保证

* 地图采用perfect maze生成，确保：
  
  * 先生成起点房间（见下文）再在剩余方格上生成地图，以避免后生成房间破坏地图结构，产生不可达区域等（但是后生成的地图也不能破坏起点房间的结构）
  * **所有格子都可达**（无孤立区域）且两格子间路径唯一

### 4.分享码

* 为每张地图生成一个分享码（不是种子，玩家编辑的地图也需要有对应的分享码），可以复制分享码，也可以粘贴分享码游玩特定地图
* 地图默认随机生成，但是玩家粘贴分享码后，若是合法的分享码，则游玩分享码对应的地图

---

## （二）起点房间（玩家出生地）

### 1. 位置与形状

* 位于地图的一个角落（目前固定为左下角）。
* 为 **3 × 3 的独立房间**。

### 2. 房间墙体构成

* 房间外周全部是墙（封闭结构）
* 仅在：

  * **房间右侧**的中间位置开一个口
  * **房间上侧**的中间位置开一个口
    → 两个开口均通往迷宫，并非直通地图边缘

### 3. 玩家出生点

* 房间中心格子

---

## （三）终点位置（胜利条件）

### 1. 终点位置要求

终点位于地图边缘，且该格子满足：

* **三面为墙**（只有一侧开放）
* 与起点尽可能**距离最远**（距离以最短路径长度计算）

### 2. 玩家胜利条件

* 当玩家移动到终点所在格子 → **玩家胜利**

---

## （四）玩家规则

### 1. 基本属性

* 初始血量：5生命
* 位置：起点房间中心格

### 2. 移动规则

* 每次移动 1 格，可用：

  * 方向键 ↑↓←→
  * WASD
* 移动前检查：

  * 目标格在地图内
  * 玩家与目标格之间没有墙

---

## （五）玩家视野规则

### 1. 可见范围定义

玩家能够看到：

* 与玩家**同一行**向左/右延伸，直到被墙阻挡的所有格子
* 与玩家**同一列**向上/下延伸，直到被墙阻挡的所有格子
* 上述可见格子的四条边，若是墙则显示出来
* 特例：初始房间的九个格子始终可见

### 2. 可见区域记忆

* 玩家**曾看见过的格子和墙永远可见**（雾探索机制，不会重新变暗）

### 3. 未曾看见的区域

* 格子会以深色阴影显示，表示未探索，未看见的墙及其它元件（如鬼、终点）都不显示

### 4. 调试视野

* 可开启调试视野模式：**显示整个地图**
* 不影响游戏逻辑，仅作为显示辅助
* 在调试模式打开时只影响显示（不记录为已见），确保调试视野关闭后回到原样，不改变“已见格”记录

---

## （六）鬼的规则（敌人）

### 1. 鬼的数量与生成

* 每局生成 **3个鬼**
* 鬼的初始位置要求：

  * 不能位于初始房间
  * 不能与终点重叠
  * 不能与其它鬼重叠

### 2. 鬼的“视线规则”

鬼只能看见玩家在同一 **行/列** 且：

* 两者之间不存在墙阻挡

### 3. 鬼的追逐行为（关键逻辑）

鬼的追逐行为依赖两种状态：

#### ① 玩家移动“前”鬼是否曾看见玩家

#### ② 玩家移动“后”鬼是否能看见玩家

玩家每进行一步移动，鬼遵循如下决策：

| 情况 | 玩家移动前鬼能看到？ | 玩家移动后鬼能看到？ | 鬼的行动              |
| -- | ---------- | ---------- | ----------------- |
| A  | 否          | 是          | 朝玩家“移动后”的位置移动 1 格 |
| B  | 是          | 否          | 朝玩家“移动前”的位置移动 1 格 |
| C  | 是          | 是          | 朝玩家“移动后”的位置移动 1 格 |
| D  | 否          | 否          | 鬼不移动      |

考虑到以后可能会加入“玻璃”，即作为墙的一种代替，视线可穿过但移动不可穿过，使用BFS算法实现鬼的移动，若鬼到目标有多条等长最短路径，则随机选一个

鬼以随机顺序先后移动。注意需要处理的特殊情况：如果即将进行的移动被鬼阻挡，为确保鬼不重叠，此次移动取消，但是下次移动时如果判定属于情况D，会强制执行此次未执行成功的移动，以防止鬼因拥挤而丢失目标（如果还被鬼阻挡而未成功则取消）

---

## （七）玩家死亡判定

### 死亡发生的时机

1. 玩家移动后，鬼移动前
2. 鬼移动后

若玩家位置与任意鬼重叠 → 玩家立即死亡

若为情况1，直接判定玩家死亡，鬼本次无需移动

---

## （八）死亡后的处理

### 若玩家血量 > 0

* 显示提示：「你死了（剩余血量 X）」
* 按下「复活」后：

  * 玩家传送回起点
  * 血量不恢复
  * 地图、鬼的位置与状态保持不变
  * 已见格保持不变

### 若玩家血量 = 0

* 显示：「你死了，游戏结束」
* 可选择：

  * 「再次游玩该地图」（重置玩家位置/血量/已见格，鬼回到初始位置，但地图和鬼的初始位置保持不变，确保进行完全相同的另一场游戏）
  * 「游玩新地图」（重新生成地图与鬼）

---

## （九）胜利后的处理

玩家到达终点后显示：

* 「你赢了！」

可选择：

* 「再次游玩该地图」
* 「游玩新地图」

---

## （十）界面/UI 相关

### 1. Canvas 绘制

* 地面、墙、鬼、玩家均绘制在 canvas 上
* 采用简约配色：

  * 地面：#dfe3e6
  * 网格标示：#dadee1
  * 未探索区：#0b0b0b
  * 墙：#495360
  * 玩家：蓝色圆形
  * 鬼：红色圆形
  * 终点：绿色圆形

### 2. HTML 浮层

用于：

* 死亡提示
* 胜利提示
* 复活/重新游戏等操作按钮

### 3. 界面元素（放在地图外，避免遮挡视线）

* 血量显示
* 调试视野开关
* 地图大小输入框
* “随机生成新地图”按钮
* “复制分享码”按钮、 “粘贴并加载”按钮（初始不生成地图，点击该按钮或点击“随机生成新地图”按钮后才会开始生成）
* “重置地图”按钮，用于重置当前地图
* “编辑地图”按钮，以当前地图的初始状态进入地图编辑器（界面不需要全部刷新，做尽可能少的改动，以保证连贯一致性；地图编辑器的功能说明见下文档）

---
